<div class="main-header">
    <div class="results-header">
        <strong>Resultados para a Conta:</strong> {{ form_data.account_name }} | <strong>Per√≠odo:</strong> {{ form_data.start_date }} a {{ form_data.end_date }}
    </div>
    <div class="header-actions">
        <a href="{{ url_for('logout') }}">Sair / Nova An√°lise</a>
    </div>
</div>

{% if is_simulation %}
<div class="simulation-warning">
    <strong>Modo de Simula√ß√£o Ativado.</strong> Os resultados abaixo excluem os pares da blacklist. 
    <button id="restore-btn" style="margin-left: 15px; background: #1A202C; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Restaurar An√°lise Original</button>
</div>
{% endif %}

<div class="kpi-container">
    <div class="kpi-card">
        <h3>PnL de Trades (USDT)</h3>
        <div class="kpi-value {{ 'positive' if kpis.total_pnl > 0 else 'negative' }}">
            {{ "%.2f"|format(kpis.total_pnl) }}
        </div>
    </div>
    <div class="kpi-card">
        <h3>Custo Total (Margem)</h3>
        <div class="kpi-value">
            {{ "%.2f"|format(kpis.total_margin_cost) }} USDT
        </div>
    </div>
    <div class="kpi-card">
        <h3>Taxa de Acerto</h3>
        <div class="kpi-value">
            {{ "%.2f"|format(kpis.win_rate) }}%
        </div>
    </div>
    <div class="kpi-card">
        <h3>ROI Agregado Total</h3>
        <div class="kpi-value {{ 'positive' if kpis.avg_roi > 0 else 'negative' }}">
            {{ "%.2f"|format(kpis.avg_roi) }}%
        </div>
    </div>
    <!-- NOVO CARD ADICIONADO ABAIXO -->
    <div class="kpi-card">
        <h3>Total de Trades</h3>
        <div class="kpi-value">
            {{ kpis.total_trades }}
        </div>
    </div>
</div>

<!-- Controles de Sele√ß√£o em Massa -->
<div class="bulk-actions-container" style="background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span id="selected-count" style="color: var(--text-muted); font-size: 0.9em;">0 pares selecionados</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="select-all-btn" class="bulk-btn" style="background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                Selecionar Todos
            </button>
            <button id="clear-selection-btn" class="bulk-btn" style="background: var(--border-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                Limpar Sele√ß√£o
            </button>
            <button id="ban-selected-btn" class="bulk-btn" style="background: var(--warning-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em;" disabled>
                Banir Selecionados
            </button>
            <button id="unban-all-btn" class="bulk-btn" style="background: var(--positive-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                Permitir Todos
            </button>
        </div>
    </div>
</div>

<div class="tabs">
    <button class="tab-link active" data-tab="winners-tab">üèÜ Ganhadores</button>
    <button class="tab-link" data-tab="losers-tab">üíî Perdedores</button>
    <button class="tab-link" data-tab="exit-type-tab">üìä Por Sa√≠da</button>
</div>

<div id="winners-tab" class="tab-content" style="display: block;">
    <h3>üèÜ Ranking de Ganhadores</h3>
    <table id="winners-table" class="results-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all-winners" class="select-all-checkbox" style="cursor: pointer;">
                </th>
                <th>Par</th>
                <th>PnL Total (USDT)</th>
                <th>ROI Agregado (%)</th>
                <th>Taxa de Acerto (%)</th>
                <th>N¬∫ de Trades</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for row in winners_summary %}
            <tr>
                <td>
                    <input type="checkbox" class="pair-checkbox" data-symbol="{{ row.symbol }}" style="cursor: pointer;">
                </td>
                <td><a href="{{ url_for('trade_details', symbol=row.symbol) }}" target="_blank">{{ row.symbol }}</a></td>
                <td class="positive">+{{ "%.2f"|format(row.total_pnl_net) }}</td>
                <td class="{{ 'positive' if row.roi_agregado > 0 else 'negative' }}">{{ "%.2f"|format(row.roi_agregado) }}</td>
                <td>{{ "%.2f"|format(row.win_rate) }}</td>
                <td>{{ row.trade_count }}</td>
                <td>
                    <div class="action-menu-container">
                        <button class="action-menu-button">‚ãÆ</button>
                        <div class="action-menu-dropdown">
                            <a href="{{ url_for('trade_details', symbol=row.symbol) }}" target="_blank">Ver Detalhes</a>
                            <button class="ban-btn ban-option" data-symbol="{{ row.symbol }}">Banir Par</button>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="losers-tab" class="tab-content">
    <h3>üíî Ranking de Perdedores</h3>
    <table id="losers-table" class="results-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all-losers" class="select-all-checkbox" style="cursor: pointer;">
                </th>
                <th>Par</th>
                <th>PnL Total (USDT)</th>
                <th>ROI Agregado (%)</th>
                <th>Taxa de Acerto (%)</th>
                <th>N¬∫ de Trades</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for row in losers_summary %}
            <tr>
                <td>
                    <input type="checkbox" class="pair-checkbox" data-symbol="{{ row.symbol }}" style="cursor: pointer;">
                </td>
                <td><a href="{{ url_for('trade_details', symbol=row.symbol) }}" target="_blank">{{ row.symbol }}</a></td>
                <td class="negative">{{ "%.2f"|format(row.total_pnl_net) }}</td>
                <td class="{{ 'positive' if row.roi_agregado > 0 else 'negative' }}">{{ "%.2f"|format(row.roi_agregado) }}</td>
                <td>{{ "%.2f"|format(row.win_rate) }}</td>
                <td>{{ row.trade_count }}</td>
                <td>
                    <div class="action-menu-container">
                        <button class="action-menu-button">‚ãÆ</button>
                        <div class="action-menu-dropdown">
                            <a href="{{ url_for('trade_details', symbol=row.symbol) }}" target="_blank">Ver Detalhes</a>
                            <button class="ban-btn ban-option" data-symbol="{{ row.symbol }}">Banir Par</button>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="exit-type-tab" class="tab-content">
    <h3>üìä Resumo por Tipo de Sa√≠da</h3>
    <table id="exit-type-table" class="results-table">
        <thead>
            <tr>
                <th>Tipo de Sa√≠da</th>
                <th>PnL Total (USDT)</th>
                <th>ROI Agregado (%)</th>
                <th>Taxa de Acerto (%)</th>
                <th>N¬∫ de Sa√≠das</th>
            </tr>
        </thead>
        <tbody>
            {% for row in exit_type_summary %}
            <tr>
                <td>{{ row.exit_type }}</td>
                <td class="{{ 'positive' if row.total_pnl_net > 0 else 'negative' }}">{{ "%.2f"|format(row.total_pnl_net) }}</td>
                <td class="{{ 'positive' if row.roi_agregado > 0 else 'negative' }}">{{ "%.2f"|format(row.roi_agregado) }}</td>
                <td>{{ "%.2f"|format(row.win_rate) }}</td>
                <td>{{ row.exit_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Funcionalidade de Sele√ß√£o em Massa
$(document).ready(function() {
    let selectedPairs = new Set();

    // Atualizar contador de selecionados
    function updateSelectedCount() {
        const count = selectedPairs.size;
        $('#selected-count').text(`${count} pares selecionados`);
        $('#ban-selected-btn').prop('disabled', count === 0);
    }

    // Checkbox individual
    $(document).on('change', '.pair-checkbox', function() {
        const symbol = $(this).data('symbol');
        if ($(this).is(':checked')) {
            selectedPairs.add(symbol);
        } else {
            selectedPairs.delete(symbol);
        }
        updateSelectedCount();
        updateSelectAllCheckboxes();
    });

    // Checkbox "Selecionar Todos" por aba
    $(document).on('change', '.select-all-checkbox', function() {
        const isChecked = $(this).is(':checked');
        const currentTab = $('.tab-content:visible');
        const checkboxes = currentTab.find('.pair-checkbox');
        
        checkboxes.each(function() {
            const symbol = $(this).data('symbol');
            $(this).prop('checked', isChecked);
            
            if (isChecked) {
                selectedPairs.add(symbol);
            } else {
                selectedPairs.delete(symbol);
            }
        });
        
        updateSelectedCount();
    });

    // Atualizar estado dos checkboxes "Selecionar Todos"
    function updateSelectAllCheckboxes() {
        $('.select-all-checkbox').each(function() {
            const tabId = $(this).attr('id');
            let tabSelector;
            
            if (tabId === 'select-all-winners') {
                tabSelector = '#winners-tab';
            } else if (tabId === 'select-all-losers') {
                tabSelector = '#losers-tab';
            }
            
            if (tabSelector) {
                const checkboxes = $(tabSelector + ' .pair-checkbox');
                const checkedBoxes = $(tabSelector + ' .pair-checkbox:checked');
                
                if (checkboxes.length === 0) {
                    $(this).prop('indeterminate', false).prop('checked', false);
                } else if (checkedBoxes.length === checkboxes.length) {
                    $(this).prop('indeterminate', false).prop('checked', true);
                } else if (checkedBoxes.length > 0) {
                    $(this).prop('indeterminate', true);
                } else {
                    $(this).prop('indeterminate', false).prop('checked', false);
                }
            }
        });
    }

    // Bot√£o "Selecionar Todos" (todas as abas)
    $('#select-all-btn').on('click', function() {
        $('.pair-checkbox').each(function() {
            const symbol = $(this).data('symbol');
            $(this).prop('checked', true);
            selectedPairs.add(symbol);
        });
        $('.select-all-checkbox').prop('checked', true).prop('indeterminate', false);
        updateSelectedCount();
    });

    // Bot√£o "Limpar Sele√ß√£o"
    $('#clear-selection-btn').on('click', function() {
        $('.pair-checkbox, .select-all-checkbox').prop('checked', false).prop('indeterminate', false);
        selectedPairs.clear();
        updateSelectedCount();
    });

    // Bot√£o "Banir Selecionados"
    $('#ban-selected-btn').on('click', function() {
        if (selectedPairs.size === 0) return;

        const pairsArray = Array.from(selectedPairs);
        const confirmation = confirm(`Tem certeza que deseja banir ${pairsArray.length} pares?\n\nPares: ${pairsArray.join(', ')}`);
        
        if (!confirmation) return;

        $(this).prop('disabled', true).text('Banindo...');

        // Enviar requisi√ß√£o para banir m√∫ltiplos pares
        fetch('/ban_multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: pairsArray
            })
        })
        .then(response => response.json())
        .then(data => {
            showFlashMessage(data.message, data.status);
            if (data.status === 'success') {
                // Atualizar blacklist na sidebar
                $('#no-blacklist-msg').hide();
                $('#recalculate-btn').show();
                
                // Adicionar pares √† lista da blacklist
                pairsArray.forEach(symbol => {
                    const blacklistItem = `<div class="blacklist-item" data-symbol="${symbol}"><span>${symbol}</span><button class="unban-btn" data-symbol="${symbol}">Permitir</button></div>`;
                    $('#blacklist-list').append(blacklistItem);
                });

                // Limpar sele√ß√£o
                selectedPairs.clear();
                $('.pair-checkbox, .select-all-checkbox').prop('checked', false).prop('indeterminate', false);
                updateSelectedCount();
            }
        })
        .catch(error => {
            showFlashMessage('Erro ao banir pares selecionados.', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            $('#ban-selected-btn').prop('disabled', false).text('Banir Selecionados');
        });
    });

    // Bot√£o "Permitir Todos"
    $('#unban-all-btn').on('click', function() {
        // Obter todos os pares da blacklist
        const blacklistItems = $('#blacklist-list .blacklist-item');
        if (blacklistItems.length === 0) {
            showFlashMessage('Nenhum par na blacklist para permitir.', 'info');
            return;
        }

        const symbols = blacklistItems.map(function() {
            return $(this).data('symbol');
        }).get();

        const confirmation = confirm(`Tem certeza que deseja permitir todos os ${symbols.length} pares da blacklist?\n\nPares: ${symbols.join(', ')}`);
        if (!confirmation) return;

        $(this).prop('disabled', true).text('Permitindo...');

        fetch('/unban_all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: symbols
            })
        })
        .then(response => response.json())
        .then(data => {
            showFlashMessage(data.message, data.status);
            if (data.status === 'success') {
                // Remover todos os itens da blacklist
                blacklistItems.remove();
                $('#no-blacklist-msg').show();
                $('#recalculate-btn').hide();
                $('#unban-all-btn').hide();
            }
        })
        .catch(error => {
            showFlashMessage('Erro ao permitir pares.', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            $('#unban-all-btn').prop('disabled', false).text('Permitir Todos');
        });
    });

    // Atualizar sele√ß√£o ao trocar de aba
    $('.tab-link').on('click', function() {
        setTimeout(updateSelectAllCheckboxes, 100);
    });

    // Inicializar
    updateSelectedCount();
});
</script>
